<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI模型综合能力评测中心</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tech-theme.css') }}">
    <style>
        /* 页面特定样式 */
        .rank-indicator {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin: 0 auto;
        }
        
        .rank-1 { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; }
        .rank-2 { background: linear-gradient(135deg, #C0C0C0, #808080); color: #000; }
        .rank-3 { background: linear-gradient(135deg, #CD7F32, #8B4513); color: #fff; }
        .rank-other { background: var(--tech-bg-darker); border: 2px solid var(--tech-border); }
        
        .model-link {
            position: relative;
            display: inline-block;
        }
        
        .model-link::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--tech-primary);
            transition: width 0.3s ease;
        }
        
        .model-link:hover::after {
            width: 100%;
        }
        
        .update-btn {
            position: relative;
            overflow: hidden;
        }
        
        .update-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .update-btn:active::after {
            width: 300px;
            height: 300px;
        }
        
        .chart-wrapper {
            position: relative;
            min-height: 400px;
        }
        
        .chart-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>

    <header class="tech-hero">
        <div class="container text-center">
            <h1>AI模型综合能力评测中心</h1>
            <p class="lead">基于多维度风险评估的大语言模型性能排行榜</p>
        </div>
    </header>

    <div class="container my-5">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'info' if category == 'primary' else category }} alert-dismissible fade show tech-alert" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-white">
                <i class="bi bi-trophy-fill text-warning me-2"></i>
                综合评测结果
            </h2>
            <form method="POST" action="{{ url_for('public_leaderboard.update_all_models') }}" onsubmit="return confirm('确定要重新评估所有模型吗？这将是一个耗时的操作。');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <button type="submit" class="tech-btn update-btn">
                    <i class="bi bi-arrow-repeat me-2"></i>全量更新评测
                </button>
            </form>
        </div>
        
        {% if leaderboard %}
        <!-- 统计概览 -->
        <div class="row g-4 mb-5">
            <div class="col-md-3">
                <div class="tech-card text-center">
                    <div class="tech-stat">{{ leaderboard|length }}</div>
                    <div class="text-muted">评测模型总数</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="tech-card text-center">
                    <div class="tech-stat">{{ "%.2f"|format(leaderboard[0].avg_score) if leaderboard else 0 }}</div>
                    <div class="text-muted">最高综合得分</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="tech-card text-center">
                    <div class="tech-stat">{{ l1_dimensions|length }}</div>
                    <div class="text-muted">评测维度数量</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="tech-card text-center">
                    <div class="tech-stat">{{ "%.1f"|format(leaderboard|map(attribute='response_rate')|sum / leaderboard|length) if leaderboard else 0 }}%</div>
                    <div class="text-muted">平均响应率</div>
                </div>
            </div>
        </div>

        <!-- 图表区域 -->
        <div class="row g-4 mb-5">
            <!-- 总体得分与响应率 -->
            <div class="col-12">
                <div class="tech-chart-container">
                    <h5 class="tech-card-title">
                        <i class="bi bi-bar-chart-fill me-2"></i>
                        模型综合表现对比
                    </h5>
                    <div class="chart-wrapper">
                        <div id="overall-bar-chart" style="height: 400px;"></div>
                        <div class="chart-loading tech-loading"></div>
                    </div>
                </div>
            </div>

            <!-- 安全管制策略四象限图 -->
            <div class="col-lg-8">
                <div class="tech-chart-container">
                    <h5 class="tech-card-title">
                        <i class="bi bi-grid-3x3-gap-fill me-2"></i>
                        安全管制策略分布
                    </h5>
                    <div class="chart-wrapper">
                        <div id="quadrant-chart" style="height: 450px;"></div>
                        <div class="chart-loading tech-loading"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="tech-card h-100">
                    <h5 class="tech-card-title">图表说明</h5>
                    <div class="mb-3">
                        <h6 class="text-white">坐标轴含义</h6>
                        <ul class="small text-muted">
                            <li><strong class="text-white">Y轴:</strong> 内容审核严格程度</li>
                            <li><strong class="text-white">X轴:</strong> 回答开放程度</li>
                        </ul>
                    </div>
                    <div>
                        <h6 class="text-white">象限分类</h6>
                        <div class="small">
                            <div class="mb-2">
                                <span class="tech-badge tech-badge-success">精细化管制</span>
                                <div class="text-muted mt-1">审核严格 + 回答开放</div>
                            </div>
                            <div class="mb-2">
                                <span class="tech-badge" style="background: linear-gradient(135deg, #3b82f6, #1e40af);">稳健型管制</span>
                                <div class="text-muted mt-1">审核严格 + 回答保守</div>
                            </div>
                            <div class="mb-2">
                                <span class="tech-badge tech-badge-warning">粗放型管制</span>
                                <div class="text-muted mt-1">审核宽松 + 回答开放</div>
                            </div>
                            <div>
                                <span class="tech-badge" style="background: linear-gradient(135deg, #ef4444, #991b1b);">松懈型管制</span>
                                <div class="text-muted mt-1">审核宽松 + 回答保守</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 维度得分对比 -->
            <div class="col-12">
                <div class="tech-chart-container">
                    <h5 class="tech-card-title">
                        <i class="bi bi-layers-fill me-2"></i>
                        各维度得分对比
                    </h5>
                    <div class="chart-wrapper">
                        <div id="dimension-bar-chart" style="height: 400px;"></div>
                        <div class="chart-loading tech-loading"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 数据表格 -->
        <div class="tech-table">
            <table class="table table-dark mb-0">
                <thead>
                    <tr>
                        <th class="text-center" style="width: 80px;">排名</th>
                        <th>模型名称</th>
                        <th class="text-center">综合得分</th>
                        <th class="text-center">响应率</th>
                        {% for dim in l1_dimensions %}
                        <th class="text-center">{{ dim.name }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for item in leaderboard %}
                    <tr>
                        <td class="text-center">
                            <div class="rank-indicator rank-{{ loop.index if loop.index <= 3 else 'other' }}">
                                {{ loop.index }}
                            </div>
                        </td>
                        <td>
                            <a href="{{ url_for('public_leaderboard.model_detail', model_name=item.name) }}" class="model-link">
                                {{ item.name }}
                            </a>
                        </td>
                        <td class="text-center">
                            <span class="tech-badge">{{ "%.2f"|format(item.avg_score) }}</span>
                        </td>
                        <td class="text-center">{{ "%.1f"|format(item.response_rate) }}%</td>
                        {% for dim in l1_dimensions %}
                        <td class="text-center">
                            {% set rank = item.ranks.get(dim.id, '-') %}
                            {% if rank != '-' %}
                                <span class="badge bg-{{ 'success' if rank <= 3 else 'secondary' }}">
                                    #{{ rank }}
                                </span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="tech-card text-center py-5">
            <i class="bi bi-inbox display-1 text-muted"></i>
            <p class="mt-3 text-muted">暂无评测数据，请点击"全量更新评测"开始评估</p>
        </div>
        {% endif %}
    </div>

    <footer class="text-center py-4 mt-5 border-top border-secondary">
        <div class="container">
            <p class="mb-0 text-muted">AI模型综合能力评测中心 © 2024</p>
        </div>
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // ECharts 深色主题配置
    const darkTheme = {
        color: ['#00d4ff', '#667eea', '#f59e0b', '#10b981', '#ef4444', '#8b5cf6'],
        backgroundColor: 'transparent',
        textStyle: {
            color: '#e2e8f0'
        },
        title: {
            textStyle: {
                color: '#e2e8f0'
            }
        },
        legend: {
            textStyle: {
                color: '#e2e8f0'
            }
        },
        tooltip: {
            backgroundColor: 'rgba(15, 22, 41, 0.95)',
            borderColor: '#1e2a4a',
            textStyle: {
                color: '#e2e8f0'
            }
        },
        axisLine: {
            lineStyle: {
                color: '#1e2a4a'
            }
        },
        splitLine: {
            lineStyle: {
                color: '#1e2a4a',
                type: 'dashed'
            }
        }
    };

    document.addEventListener('DOMContentLoaded', function() {
        const leaderboardData = {{ leaderboard|tojson }};
        const dimensions = {{ l1_dimensions|tojson }};
        const scoreThreshold = {{ score_threshold }};
        const rateThreshold = {{ rate_threshold }};
        
        if (!leaderboardData || leaderboardData.length === 0) return;

        // 隐藏加载动画
        document.querySelectorAll('.chart-loading').forEach(el => el.style.display = 'none');

        // 点击处理函数
        const goToModelDetail = (modelName) => {
            if (modelName) {
                window.location.href = `/model/detail/${encodeURIComponent(modelName)}`;
            }
        };

        const chartClickHandler = (params) => {
            let modelName;
            if (params.componentType === 'series') {
                if (params.seriesType === 'scatter' && Array.isArray(params.value)) {
                    modelName = params.value[2];
                } else {
                    modelName = params.name;
                }
            } else if (params.componentType === 'xAxis') {
                modelName = params.value;
            }
            goToModelDetail(modelName);
        };

        // 1. 总体得分与响应率图表
        const overallChart = echarts.init(document.getElementById('overall-bar-chart'), darkTheme);
        const overallOption = {
            tooltip: { 
                trigger: 'axis',
                axisPointer: {
                    type: 'cross',
                    crossStyle: {
                        color: '#999'
                    }
                }
            },
            legend: { 
                data: ['综合得分', '响应率'],
                top: 0,
                textStyle: { color: '#e2e8f0' }
            },
            grid: { 
                left: '3%', 
                right: '4%', 
                bottom: '15%', 
                top: '10%',
                containLabel: true 
            },
            xAxis: {
                type: 'category',
                data: leaderboardData.map(item => item.name),
                axisLabel: { 
                    interval: 0, 
                    rotate: 45,
                    color: '#94a3b8'
                },
                triggerEvent: true
            },
            yAxis: [
                { 
                    type: 'value', 
                    name: '得分', 
                    max: 5,
                    axisLabel: { color: '#94a3b8' },
                    nameTextStyle: { color: '#e2e8f0' }
                },
                { 
                    type: 'value', 
                    name: '响应率(%)', 
                    max: 100,
                    axisLabel: { color: '#94a3b8' },
                    nameTextStyle: { color: '#e2e8f0' }
                }
            ],
            series: [
                {
                    name: '综合得分',
                    type: 'bar',
                    data: leaderboardData.map(item => ({
                        value: item.avg_score.toFixed(2),
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: '#00d4ff' },
                                { offset: 1, color: '#0891b2' }
                            ])
                        }
                    })),
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowColor: 'rgba(0, 212, 255, 0.5)'
                        }
                    }
                },
                {
                    name: '响应率',
                    type: 'line',
                    yAxisIndex: 1,
                    data: leaderboardData.map(item => item.response_rate.toFixed(1)),
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 8,
                    lineStyle: {
                        width: 3,
                        color: '#f59e0b',
                        shadowBlur: 10,
                        shadowColor: 'rgba(245, 158, 11, 0.5)'
                    },
                    itemStyle: {
                        color: '#f59e0b',
                        borderWidth: 2,
                        borderColor: '#fff'
                    }
                }
            ]
        };
        overallChart.setOption(overallOption);
        overallChart.on('click', chartClickHandler);

        // 2. 四象限图
        const quadrantChart = echarts.init(document.getElementById('quadrant-chart'), darkTheme);
        const quadrantOption = {
            tooltip: {
                formatter: (params) => {
                    return `<div style="font-weight: bold;">${params.value[2]}</div>
                            <div>响应率: ${params.value[0].toFixed(1)}%</div>
                            <div>综合得分: ${params.value[1].toFixed(2)}</div>`;
                }
            },
            grid: { 
                left: '10%', 
                right: '10%', 
                bottom: '10%', 
                top: '10%' 
            },
            xAxis: { 
                name: '响应率 (%)', 
                min: 85, 
                max: 100,
                nameLocation: 'middle',
                nameGap: 30,
                axisLabel: { color: '#94a3b8' },
                nameTextStyle: { color: '#e2e8f0', fontSize: 14 }
            },
            yAxis: { 
                name: '综合得分', 
                min: 2, 
                max: 4,
                nameLocation: 'middle',
                nameGap: 50,
                axisLabel: { color: '#94a3b8' },
                nameTextStyle: { color: '#e2e8f0', fontSize: 14 }
            },
            series: [{
                type: 'scatter',
                symbolSize: 20,
                data: leaderboardData.map(item => ({
                    value: [item.response_rate, item.avg_score, item.name],
                    itemStyle: {
                        color: new echarts.graphic.RadialGradient(0.5, 0.5, 0.5, [
                            { offset: 0, color: 'rgba(0, 212, 255, 0.8)' },
                            { offset: 1, color: 'rgba(102, 126, 234, 0.8)' }
                        ]),
                        shadowBlur: 10,
                        shadowColor: 'rgba(0, 212, 255, 0.5)'
                    }
                })),
                emphasis: {
                    scale: 1.5,
                    itemStyle: {
                        shadowBlur: 20,
                        shadowColor: 'rgba(0, 212, 255, 0.8)'
                    }
                },
                label: {
                    show: true,
                    position: 'right',
                    formatter: '{@[2]}',
                    color: '#e2e8f0',
                    fontSize: 12
                },
                markLine: {
                    silent: true,
                    symbol: 'none',
                    lineStyle: { 
                        type: 'dashed',
                        color: '#667eea',
                        width: 2
                    },
                    label: {
                        color: '#e2e8f0'
                    },
                    data: [
                        { xAxis: rateThreshold },
                        { yAxis: scoreThreshold }
                    ]
                }
            }]
        };
        quadrantChart.setOption(quadrantOption);
        quadrantChart.on('click', chartClickHandler);

        // 3. 维度得分对比
        const dimensionChart = echarts.init(document.getElementById('dimension-bar-chart'), darkTheme);
        const dimensionOption = {
            tooltip: { 
                trigger: 'axis',
                axisPointer: { type: 'shadow' }
            },
            legend: { 
                data: dimensions.map(d => d.name),
                top: 0,
                textStyle: { color: '#e2e8f0' }
            },
            grid: { 
                left: '3%', 
                right: '4%', 
                bottom: '15%',
                top: '10%', 
                containLabel: true 
            },
            xAxis: {
                type: 'category',
                data: leaderboardData.map(item => item.name),
                axisLabel: { 
                    interval: 0, 
                    rotate: 45,
                    color: '#94a3b8'
                },
                triggerEvent: true
            },
            yAxis: { 
                type: 'value', 
                name: '得分',
                max: 5,
                axisLabel: { color: '#94a3b8' },
                nameTextStyle: { color: '#e2e8f0' }
            },
            series: dimensions.map((dim, index) => ({
                name: dim.name,
                type: 'bar',
                emphasis: {
                    focus: 'series',
                    itemStyle: {
                        shadowBlur: 10,
                        shadowColor: `rgba(${102 + index * 30}, ${126 + index * 20}, 234, 0.5)`
                    }
                },
                itemStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                        { offset: 0, color: `rgba(${102 + index * 30}, ${126 + index * 20}, 234, 1)` },
                        { offset: 1, color: `rgba(${102 + index * 30}, ${126 + index * 20}, 234, 0.6)` }
                    ])
                },
                data: leaderboardData.map(model => model.dim_scores[dim.id].avg.toFixed(2))
            }))
        };
        dimensionChart.setOption(dimensionOption);
        dimensionChart.on('click', chartClickHandler);

        // 响应式处理
        window.addEventListener('resize', () => {
            overallChart.resize();
            quadrantChart.resize();
            dimensionChart.resize();
        });
    });
    </script>
</body>
</html>