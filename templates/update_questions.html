<!-- .\templates\update_questions.html -->
{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>问题列表与评估</h2>
        <div id="alert-container" style="position: fixed; top: 80px; right: 20px; z-index: 1050;"></div>
    </div>
    
    <form method="POST" id="bulk-action-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <!-- 
            解决方案: 在表格上添加一个 data-* 属性来存储 URL 模板。
            我们用一个占位符 (如 0) 来生成模板，稍后用 JS 替换它。
        -->
        <div class="card" 
             data-status-url-template="{{ url_for('questions.get_question_status', question_id=0) }}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>共 {{ questions|length }} 个问题</span>
                <div class="btn-group" role="group">
                    <button type="submit" name="action" value="update" formaction="{{ url_for('questions.bulk_action') }}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-arrow-repeat"></i> 批量更新
                    </button>
                    <button type="submit" name="action" value="delete" formaction="{{ url_for('questions.bulk_action') }}" class="btn btn-sm btn-outline-danger" id="bulk-delete-btn">
                        <i class="bi bi-trash"></i> 批量删除
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <!-- 表头部分保持不变 -->
                    <thead>
                        <tr>
                            <th class="text-center" style="width: 5%;"><input class="form-check-input" type="checkbox" id="select-all"></th>
                            <th style="width: 10%;">ID</th>
                            <th>问题内容</th>
                            <th style="width: 20%;">维度</th>
                            <th style="width: 10%;">类型</th>
                            <th style="width: 10%;">状态</th>
                            <th style="width: 15%;" class="text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for question in questions %}
                        <tr id="question-row-{{ question.id }}">
                            <td class="text-center"><input class="form-check-input question-checkbox" type="checkbox" name="question_ids" value="{{ question.id }}"></td>
                            <td>{{ question.id }}</td>
                            <td>
                                <a href="{{ url_for('questions.question_detail', question_id=question.id) }}" class="text-decoration-none">
                                    {{ question.content[:50] }}{% if question.content|length > 50 %}...{% endif %}
                                </a>
                            </td>
                            <td>
                                {% set dim = question.dimension %}
                                {% if dim and dim.parent_ref and dim.parent_ref.parent_ref %}
                                    <small>{{ dim.parent_ref.parent_ref.name }} > {{ dim.parent_ref.name }} > {{ dim.name }}</small>
                                {% elif dim %}
                                    <small>{{ dim.name }}</small>
                                {% else %}
                                    <span class="text-muted small">未分配</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if question.question_type == 'objective' %}
                                <span class="badge bg-success">客观题</span>
                                {% else %}
                                <span class="badge bg-info">主观题</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge {% if question.answers|length > 0 %}bg-success{% else %}bg-warning text-dark{% endif %}" id="status-{{ question.id }}">
                                    {% if question.answers|length > 0 %}已评估{% else %}待评估{% endif %}
                                </span>
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-sm btn-outline-primary update-btn" data-id="{{ question.id }}">更新</button>
                                <button type="submit" class="btn btn-sm btn-outline-danger" 
                                        formaction="{{ url_for('questions.delete_question', question_id=question.id) }}"
                                        onclick="return confirm('确定要永久删除这个问题吗？此操作不可撤销。');">删除</button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center py-4">暂无问题，请先 <a href="{{ url_for('questions.add_question') }}">添加题目</a>。</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const alertContainer = document.getElementById('alert-container');
    // 从 data-* 属性中获取 URL 模板
    const statusUrlTemplate = document.querySelector('.card').dataset.statusUrlTemplate;

    // 函数：动态创建并显示一个 Bootstrap alert
    function showAlert(message, category = 'info') {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `
            <div class="alert alert-${category} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        alertContainer.append(wrapper);
        // 5秒后自动消失
        setTimeout(() => {
            wrapper.remove();
        }, 5000);
    }

    // 函数：轮询问题状态
    function pollStatus(questionId, button, statusBadge) {
        const intervalId = setInterval(() => {
            // 解决方案: 使用模板替换占位符来生成正确的 URL
            const url = statusUrlTemplate.replace('0', questionId);
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.status === '已评估') {
                        clearInterval(intervalId);
                        statusBadge.className = 'badge bg-success';
                        statusBadge.textContent = '已评估';
                        button.disabled = false;
                        button.innerHTML = '更新';
                        showAlert(`问题 ${questionId} 已成功完成评估！`, 'success');
                    }
                })
                .catch(error => {
                    console.error('Polling Error:', error);
                    clearInterval(intervalId);
                    button.disabled = false;
                    button.innerHTML = '更新';
                    showAlert(`检查问题 ${questionId} 状态时出错。`, 'danger');
                });
        }, 3000);
    }
    
    // --- 单个问题更新逻辑 ---
    document.querySelectorAll('.update-btn').forEach(button => {
        button.addEventListener('click', function() {
            const questionId = this.getAttribute('data-id');
            const statusBadge = document.getElementById('status-' + questionId);
            
            // 1. 立即更新UI为处理中状态
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            if (statusBadge) {
                statusBadge.className = 'badge bg-secondary';
                statusBadge.textContent = '处理中';
            }
            
            // 2. 发送请求
            fetch("{{ url_for('questions.update_questions') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': '{{ csrf_token() }}' },
                body: `question_id=${questionId}`
            })
            .then(response => response.json())
            .then(data => {
                // 3. 处理任务入队的响应
                if (data.status === 'queued') {
                    showAlert(data.message, 'info'); // 动态显示成功入队的消息
                    // 4. 开始轮询最终状态
                    pollStatus(questionId, button, statusBadge);
                } else {
                    // 如果入队失败
                    showAlert(data.message || `启动问题 ${questionId} 更新失败。`, 'danger');
                    button.disabled = false;
                    button.innerHTML = '更新';
                    statusBadge.className = 'badge bg-danger';
                    statusBadge.textContent = '失败';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert(`与服务器通信失败，请重试。`, 'danger');
                button.disabled = false;
                button.innerHTML = '更新';
            });
        });
    });

    // --- 批量操作逻辑 (保持不变) ---
    const selectAllCheckbox = document.getElementById('select-all');
    const questionCheckboxes = document.querySelectorAll('.question-checkbox');
    const bulkActionForm = document.getElementById('bulk-action-form');
    
    if(selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            questionCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
    }

    if(bulkActionForm){
        bulkActionForm.addEventListener('submit', function(event) {
            const submitter = event.submitter;
            if (submitter && submitter.value === 'delete') {
                const selectedCount = document.querySelectorAll('.question-checkbox:checked').length;
                if (selectedCount === 0) {
                    alert('请至少选择一个问题进行删除。');
                    event.preventDefault(); 
                    return;
                }
                if (!confirm(`您确定要永久删除选中的 ${selectedCount} 个问题吗？此操作不可撤销。`)) {
                    event.preventDefault(); 
                }
            }
        });
    }
});
</script>
{% endblock %}